global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend ollama_frontend
    bind *:443 ssl crt /etc/ssl/private/ollama.pem
    mode http
    
    # 基础安全配置
    option forwardfor
    http-request deny if { src -f /etc/haproxy/blacklist.ip }
    
    # 访问控制
    acl is_api path_beg /api/
    acl is_chat path_beg /api/chat
    acl is_generate path_beg /api/generate
    
    # 流量控制
    stick-table type ip size 100k expire 30s store conn_cur,conn_rate(3s),http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 20 }
    
    # 路由规则
    use_backend ollama_chat if is_chat
    use_backend ollama_generate if is_generate
    default_backend ollama_api

backend ollama_api
    mode http
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    server ollama1 127.0.0.1:11434 check inter 2000 rise 2 fall 3

backend ollama_chat
    mode http
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    timeout server 300s
    server ollama1 127.0.0.1:11434 check maxconn 100

backend ollama_generate
    mode http
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    timeout server 300s
    server ollama1 127.0.0.1:11434 check maxconn 100